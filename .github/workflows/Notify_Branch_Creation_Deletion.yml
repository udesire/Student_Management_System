name: Notify Fork Owners by Email

on:
  create:
    branches: ['*']
  delete:
    branches: ['*']

jobs:
  send-email-notification:
    runs-on: ubuntu-latest
    if: github.event.ref_type == 'branch'
    
    steps:
      - name: æ£€æŸ¥å¹¶è·³è¿‡ç‰¹å®šåˆ†æ”¯
        id: check-branch
        run: |
          BRANCH_NAME="${{ github.event.ref }}"
          CLEAN_BRANCH="${BRANCH_NAME#refs/heads/}"
          
          # è¦è·³è¿‡çš„åˆ†æ”¯æ¨¡å¼
          SKIP_PATTERNS="gh-pages dependabot renovate test-"
          
          for pattern in $SKIP_PATTERNS; do
            if [[ "$CLEAN_BRANCH" == *"$pattern"* ]]; then
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "branch_name=$CLEAN_BRANCH" >> $GITHUB_OUTPUT
              echo "event_type=${{ github.event_name }}" >> $GITHUB_OUTPUT
              echo "å·²è·³è¿‡åˆ†æ”¯: $CLEAN_BRANCH (åŒ¹é…: $pattern)"
              exit 0
            fi
          done
          
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "branch_name=$CLEAN_BRANCH" >> $GITHUB_OUTPUT
          echo "event_type=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "å¤„ç†åˆ†æ”¯: $CLEAN_BRANCH"
      
      - name: è·å–æ‰€æœ‰ fork ä»“åº“ä¿¡æ¯
        if: steps.check-branch.outputs.skip == 'false'
        id: get-forks
        uses: actions/github-script@v7
        with:
          script: |
            console.log('å¼€å§‹è·å– fork ä»“åº“ä¿¡æ¯...');
            
            try {
              // è·å– fork ä»“åº“åˆ—è¡¨
              const forks = await github.paginate(
                github.rest.repos.listForks,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: 100
                }
              );
              
              const forkOwners = [...new Set(forks.map(fork => fork.owner.login))];
              console.log(`æ‰¾åˆ° ${forkOwners.length} ä¸ª fork æ‰€æœ‰è€…:`, forkOwners);
              
              // å°†ç»“æœå­˜å‚¨åœ¨æ–‡ä»¶ä¸­ä¾›åç»­æ­¥éª¤ä½¿ç”¨
              const fs = require('fs');
              const filePath = `${process.env.GITHUB_WORKSPACE}/fork-owners.json`;
              fs.writeFileSync(filePath, JSON.stringify(forkOwners));
              
              // ä¿å­˜è®¡æ•°
              const summary = {
                total_forks: forks.length,
                unique_owners: forkOwners.length,
                timestamp: new Date().toISOString()
              };
              fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/summary.json`, JSON.stringify(summary));
              
              console.log('æ•°æ®å·²ä¿å­˜åˆ°æ–‡ä»¶');
              return forkOwners;
              
            } catch (error) {
              console.error('è·å– fork ä»“åº“å¤±è´¥:', error.message);
              // è¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯å¤±è´¥
              return [];
            }
      
      - name: å®‰è£…ä¾èµ–
        if: steps.check-branch.outputs.skip == 'false'
        run: |
          npm init -y --silent
          npm install nodemailer @octokit/rest
          echo "ä¾èµ–å®‰è£…å®Œæˆ"
      
      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if: steps.check-branch.outputs.skip == 'false'
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          EVENT_TYPE: ${{ steps.check-branch.outputs.event_type }}
          BRANCH_NAME: ${{ steps.check-branch.outputs.branch_name }}
          REPOSITORY: ${{ github.repository }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_URL: https://github.com/${{ github.repository }}
        run: |
          # åˆ›å»ºé‚®ä»¶å‘é€è„šæœ¬ - ä½¿ç”¨ EOF ä½†ä¸å¸¦å•å¼•å·
          cat > send-notifications.js << 'EOF'
          const nodemailer = require('nodemailer');
          const { Octokit } = require('@octokit/rest');
          const fs = require('fs');
          const path = require('path');
          
          // é…ç½®
          const config = {
            smtp: {
              host: process.env.SMTP_HOST,
              port: parseInt(process.env.SMTP_PORT) || 587,
              secure: false,
              auth: {
                user: process.env.SMTP_USER,
                pass: process.env.SMTP_PASS
              },
              tls: { rejectUnauthorized: false }
            },
            github: {
              token: process.env.PAT_TOKEN
            },
            event: {
              type: process.env.EVENT_TYPE,
              branch: process.env.BRANCH_NAME,
              repository: process.env.REPOSITORY,
              repoOwner: process.env.REPO_OWNER,
              repoUrl: process.env.REPO_URL
            }
          };
          
          // è¯»å– fork æ‰€æœ‰è€…åˆ—è¡¨
          let forkOwners = [];
          try {
            forkOwners = JSON.parse(fs.readFileSync(path.join(process.env.GITHUB_WORKSPACE, 'fork-owners.json'), 'utf8'));
          } catch (error) {
            console.log('æ— æ³•è¯»å– fork æ‰€æœ‰è€…åˆ—è¡¨:', error.message);
            process.exit(1);
          }
          
          console.log(`éœ€è¦é€šçŸ¥ ${forkOwners.length} ä¸ª fork æ‰€æœ‰è€…`);
          
          // åˆ›å»ºé‚®ä»¶ä¼ è¾“å™¨
          const transporter = nodemailer.createTransport(config.smtp);
          
          // åˆ›å»º GitHub å®¢æˆ·ç«¯
          const octokit = new Octokit({ auth: config.github.token });
          
          // è·å–ç”¨æˆ·é‚®ç®±
          async function getUserEmail(username) {
            try {
              const { data: user } = await octokit.users.getByUsername({ username });
              
              if (user.email) {
                return user.email;
              }
              
              return null;
            } catch (error) {
              console.log(`è·å–ç”¨æˆ· ${username} ä¿¡æ¯å¤±è´¥:`, error.message);
              return null;
            }
          }
          
          // ç”Ÿæˆé‚®ä»¶å†…å®¹
          function createEmailContent(username, email) {
            const isCreate = config.event.type === 'create';
            const actionText = isCreate ? 'åˆ›å»º' : 'åˆ é™¤';
            const subject = isCreate 
              ? `ğŸš€ æ–°åˆ†æ”¯åˆ›å»ºé€šçŸ¥: ${config.event.branch}` 
              : `ğŸ—‘ï¸ åˆ†æ”¯åˆ é™¤é€šçŸ¥: ${config.event.branch}`;
            
            const html = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>GitHub åˆ†æ”¯å˜æ›´é€šçŸ¥</title>
          </head>
          <body>
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
              <div style="background: ${isCreate ? '#2ea44f' : '#d73a49'}; color: white; padding: 20px; text-align: center; border-radius: 5px;">
                <h1>${isCreate ? 'ğŸš€ æ–°åˆ†æ”¯å·²åˆ›å»º' : 'ğŸ—‘ï¸ åˆ†æ”¯å·²åˆ é™¤'}</h1>
                <p>GitHub ä»“åº“åˆ†æ”¯å˜æ›´é€šçŸ¥</p>
              </div>
              
              <div style="padding: 20px;">
                <p>å°Šæ•¬çš„ <strong>${username}</strong>ï¼Œæ‚¨å¥½ï¼</p>
                
                <p>æ‚¨å…³æ³¨çš„ GitHub ä»“åº“ <strong>${config.event.repository}</strong> æœ‰æ–°çš„åˆ†æ”¯å˜æ›´ï¼š</p>
                
                <div style="background: #f6f8fa; border: 1px solid #e1e4e8; border-radius: 5px; padding: 15px; margin: 20px 0; font-family: monospace;">
                  <strong>${actionText}çš„åˆ†æ”¯ï¼š</strong><br>
                  ${config.event.branch}
                </div>
                
                ${isCreate 
                  ? '<p>æ­¤åˆ†æ”¯åŒ…å«äº†æ–°çš„åŠŸèƒ½æˆ–ä¿®å¤ï¼Œå»ºè®®æ‚¨æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥åˆ°æ‚¨çš„ fork ä»“åº“ã€‚</p>'
                  : '<p>æ­¤åˆ†æ”¯å·²è¢«åˆ é™¤ï¼Œå»ºè®®æ‚¨æ£€æŸ¥å¹¶æ¸…ç† fork ä»“åº“ä¸­çš„å¯¹åº”åˆ†æ”¯ã€‚</p>'
                }
                
                <p><strong>è¯¦ç»†ä¿¡æ¯ï¼š</strong></p>
                <ul>
                  <li>ä»“åº“ï¼š${config.event.repository}</li>
                  <li>åˆ†æ”¯ï¼š${config.event.branch}</li>
                  <li>æ“ä½œï¼š${actionText}</li>
                  <li>æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</li>
                </ul>
                
                <a href="${config.event.repoUrl}${isCreate ? '/tree/' + encodeURIComponent(config.event.branch) : ''}" 
                   style="display: inline-block; background: #0366d6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-top: 20px;">
                  ${isCreate ? 'æŸ¥çœ‹æ–°åˆ†æ”¯' : 'æŸ¥çœ‹ä»“åº“'}
                </a>
              </div>
              
              <div style="background: #f6f8fa; padding: 20px; text-align: center; color: #6a737d; font-size: 12px; border-top: 1px solid #eaecef;">
                <p>è¿™æ˜¯ä¸€å°è‡ªåŠ¨å‘é€çš„ GitHub Actions é€šçŸ¥é‚®ä»¶</p>
                <p>å‘ä»¶äººï¼š${config.event.repoOwner} | ç³»ç»Ÿé€šçŸ¥è¯·å‹¿å›å¤</p>
              </div>
            </div>
          </body>
          </html>
            `;
            
            const text = `
          GitHub åˆ†æ”¯å˜æ›´é€šçŸ¥
          
          å°Šæ•¬çš„ ${username}ï¼Œæ‚¨å¥½ï¼
          
          æ‚¨å…³æ³¨çš„ GitHub ä»“åº“ ${config.event.repository} å·²${actionText}åˆ†æ”¯ï¼š
          åˆ†æ”¯åç§°ï¼š${config.event.branch}
          
          ${isCreate 
            ? 'æ­¤åˆ†æ”¯åŒ…å«äº†æ–°çš„åŠŸèƒ½æˆ–ä¿®å¤ï¼Œå»ºè®®æ‚¨æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥åˆ°æ‚¨çš„ fork ä»“åº“ã€‚'
            : 'æ­¤åˆ†æ”¯å·²è¢«åˆ é™¤ï¼Œå»ºè®®æ‚¨æ£€æŸ¥å¹¶æ¸…ç† fork ä»“åº“ä¸­çš„å¯¹åº”åˆ†æ”¯ã€‚'
          }
          
          è¯¦ç»†ä¿¡æ¯ï¼š
          ä»“åº“ï¼š${config.event.repository}
          åˆ†æ”¯ï¼š${config.event.branch}
          æ“ä½œï¼š${actionText}
          æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}
          
          é“¾æ¥ï¼š${config.event.repoUrl}${isCreate ? '/tree/' + config.event.branch : ''}
          
          -- 
          è¿™æ˜¯è‡ªåŠ¨å‘é€çš„ GitHub Actions é€šçŸ¥
            `;
            
            return { subject, html, text };
          }
          
          // ä¸»å‡½æ•°ï¼šå‘é€é‚®ä»¶
          async function sendNotifications() {
            console.log('å¼€å§‹å‘é€é‚®ä»¶é€šçŸ¥...');
            
            for (const username of forkOwners) {
              try {
                console.log(`å¤„ç†ç”¨æˆ·: ${username}`);
                
                // 1. è·å–ç”¨æˆ·é‚®ç®±
                const email = await getUserEmail(username);
                
                if (!email) {
                  console.log(`  è·³è¿‡ ${username}ï¼Œæ²¡æœ‰æ‰¾åˆ°é‚®ç®±åœ°å€`);
                  continue;
                }
                
                // 2. åˆ›å»ºé‚®ä»¶å†…å®¹
                const { subject, html, text } = createEmailContent(username, email);
                
                // 3. å‘é€é‚®ä»¶
                const mailOptions = {
                  from: `"${config.event.repoOwner} - GitHub Notifications" <${config.smtp.auth.user}>`,
                  to: email,
                  subject: subject,
                  html: html,
                  text: text
                };
                
                const info = await transporter.sendMail(mailOptions);
                console.log(`  é‚®ä»¶å·²å‘é€è‡³: ${email}`);
                
              } catch (error) {
                console.log(`  å¤„ç† ${username} æ—¶å‡ºé”™:`, error.message);
              }
            }
            
            console.log('é‚®ä»¶å‘é€ä»»åŠ¡å®Œæˆï¼');
          }
          
          // æ‰§è¡Œ
          sendNotifications().catch(console.error);
          EOF
                    
                    # è¿è¡Œé‚®ä»¶å‘é€è„šæœ¬
                    echo "å¼€å§‹å‘é€é‚®ä»¶é€šçŸ¥..."
                    node send-notifications.js
                
      - name: æ˜¾ç¤ºæ‰§è¡Œç»“æœ
        if: always()
        run: |
          echo "é€šçŸ¥æ‰§è¡Œå®Œæˆ"
          echo "äº‹ä»¶ç±»å‹: ${{ steps.check-branch.outputs.event_type }}"
          echo "åˆ†æ”¯åç§°: ${{ steps.check-branch.outputs.branch_name }}"
